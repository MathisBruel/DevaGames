{% extends "base.html" %}

{% block title %}Jeu en cours{% endblock %}

{% block content %}
<div class="game-info animate__animated animate__fadeIn">
    <div>
        <strong>Round:</strong> {{ state.current_round }} / {{ state.max_rounds }}
    </div>
    <div>
        <strong>Tour de:</strong> <span style="color: var(--accent-gold); font-size: 1.2em;">{{ state.current_player
            }}</span>
    </div>
</div>

{% if state.current_question %}
<div class="question-container animate__animated animate__zoomIn">
    <div class="question-box">
        <div class="question-text">{{ state.current_question.question }}</div>
    </div>

    <form id="answerForm" action="{{ url_for('main.answer') }}" method="post">
        <input type="hidden" name="player_name" value="{{ state.current_player }}">
        <input type="hidden" name="answer" id="selected_answer">

        <div class="options-grid">
            {% for option in state.current_question.options %}
            <button type="button" class="option-btn" onclick="submitAnswer(this, '{{ option|replace("'", "\\'") }}')">
                <span class="option-letter">{{ ['A', 'B', 'C', 'D'][loop.index0] }}:</span> {{ option }}
            </button>
            {% endfor %}
        </div>
    </form>
</div>
{% else %}
<div class="question-box">
    Chargement de la question...
</div>
{% endif %}

<!-- current scores mini-view -->
<div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
    <h3>Scores en direct</h3>
    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        {% for player in state.leaderboard %}
        <div style="text-align: center; opacity: {{ 1 if player.name == state.current_player else 0.5 }}">
            <img src="{{ player.avatar_url }}" style="width: 30px; height: 30px; border-radius: 50%;">
            <div>{{ player.name }}: {{ player.score }}</div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function submitAnswer(btn, answer) {
        // Disable all buttons
        const buttons = document.querySelectorAll('.option-btn');
        buttons.forEach(b => b.disabled = true);

        // Highlight selected
        btn.style.background = '#d4af37';
        btn.style.color = '#020b3a';

        document.getElementById('selected_answer').value = answer;

        // Send via AJAX to show result before redirecting/reloading
        const form = document.getElementById('answerForm');
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Show correct/wrong
                    if (data.correct) {
                        btn.classList.add('correct');
                        btn.style.background = 'var(--correct-green)';
                    } else {
                        btn.classList.add('wrong');
                        btn.style.background = 'var(--wrong-red)';

                        // Highlight correct one logic if needed, but 'Qui veut gagner' usually just shows you lost or won.
                        // Let's find the correct button to show it
                        buttons.forEach(b => {
                            if (b.innerText.includes(data.correct_answer) || // simple check
                                b.textContent.trim().endsWith(data.correct_answer)) { // safer check depending on formatting
                                b.classList.add('correct');
                                b.style.background = 'var(--correct-green)';
                            }
                        });
                    }

                    // Wait a moment then reload
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    console.error(data.message);
                    window.location.reload();
                }
            });
    }
</script>
{% endblock %}
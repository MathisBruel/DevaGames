{% extends "base.html" %}

{% block title %}Lobby{% endblock %}

{% block content %}
<div class="container">
    <div class="lobby-container">

        <!-- QR Code Section -->
        <div class="qr-section card" style="width: 400px; display: flex; flex-direction: column; align-items: center;">
            <h2 style="color: var(--highlight-color); margin-bottom: 20px;">SCANNEZ POUR JOUER</h2>

            <div style="background: white; padding: 20px; border-radius: var(--border-radius);">
                <img src="data:{{ qr_type or 'image/png' }};base64,{{ qr_code }}"
                    style="width: 100%; height: auto; display: block;">
            </div>

            <p style="margin-top: 20px; color: var(--text-secondary);">OU REJOIGNEZ SUR</p>
            <div class="join-url" style="word-break: break-all; font-size: 0.9rem; max-width: 100%;">{{ join_url }}
            </div>
        </div>

        <!-- Players List Section -->
        <div class="card" style="width: 450px; height: 600px; display: flex; flex-direction: column; padding: 0;">
            <div
                style="padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">PARTICIPANTS</h3>
                <span id="count-badge"
                    style="background: var(--panel-color); padding: 5px 10px; border-radius: 20px; font-weight: bold;">
                    <span id="player-count">0</span> / <span id="max-players">?</span>
                </span>
            </div>

            <div style="flex: 1; overflow-y: auto; padding: 20px;" id="player-list-container">
                <ul id="player-list" class="leaderboard-list">
                    <!-- JS Populated -->
                </ul>
                <p id="status-msg"
                    style="text-align: center; color: var(--text-secondary); margin-top: 40px; font-style: italic;">
                    En attente de connexion...
                </p>
            </div>

            <div style="padding: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button id="start-btn" class="btn" style="width: 100%; padding: 15px; font-size: 1.2rem;"
                    onclick="startGame()" disabled>
                    LANCER LA PARTIE
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const sessionId = "{{ session_id }}";

    // Waiting Music (loops in lobby)
    const waitingMusic = new Audio('/static/musiques/waiting.mp3');
    waitingMusic.loop = true;
    waitingMusic.volume = 0.4;

    // Start music on first user interaction
    document.addEventListener('click', function startMusic() {
        waitingMusic.play().catch(e => console.log('Music blocked'));
        document.removeEventListener('click', startMusic);
    }, { once: true });

    // Try autoplay
    waitingMusic.play().catch(e => console.log('Waiting for interaction to start music'));

    function pollState() {
        fetch(`/api/game/${sessionId}/state`)
            .then(r => r.json())
            .then(data => {
                // Check if started
                if (data.is_started) {
                    window.location.reload();
                    return;
                }

                // Update Counts
                document.getElementById('player-count').innerText = data.players_count;
                document.getElementById('max-players').innerText = data.max_players;

                // Update Button
                const btn = document.getElementById('start-btn');
                const msg = document.getElementById('status-msg');
                const list = document.getElementById('player-list');
                const listContainer = document.getElementById('player-list-container');

                if (data.players_count >= data.min_players) {
                    btn.disabled = false;
                    btn.style.backgroundColor = "var(--success-color)";
                    btn.innerText = "LANCER LA PARTIE";
                    msg.style.display = 'none';
                } else {
                    btn.disabled = true;
                    btn.style.backgroundColor = "var(--panel-color)";
                    let needed = data.min_players - data.players_count;
                    msg.style.display = 'block';
                    msg.innerText = `En attente de ${needed} joueur${needed > 1 ? 's' : ''} supplÃ©mentaire${needed > 1 ? 's' : ''}...`;
                }

                // Render List
                list.innerHTML = "";
                data.leaderboard.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'leaderboard-item animate__animated animate__fadeIn';
                    li.innerHTML = `
                        <img src="${player.avatar_url}" class="avatar">
                        <span class="player-name" style="font-size: 1.1rem;">${player.name}</span>
                    `;
                    list.appendChild(li);
                });
            });
    }

    function startGame() {
        const btn = document.getElementById('start-btn');
        btn.innerText = "LANCEMENT...";

        // Stop waiting music and set flag for game music autoplay
        waitingMusic.pause();
        sessionStorage.setItem('audioEnabled', 'true');

        fetch(`/api/game/${sessionId}/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        }).then(r => r.json()).then(data => {
            if (!data.success) {
                btn.innerText = "ERREUR";
                setTimeout(() => btn.innerText = "LANCER LA PARTIE", 2000);
            }
        });
    }

    setInterval(pollState, 1000);
    pollState();
</script>
{% endblock %}